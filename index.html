<html>

<head>
    <title>Simple Contact Book</title>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="bootstrap/css/bootstrap.min.css" />
</head>

<body>
    <h1>Simple Contact Book</h1>

    <div id="nav">
        <a href="">Add contact</a>

    </div>

    <!-- Add contact form-->
    <div>

        <label for="name_field">Name:</label>
        <input type="text" name="tasktitle" id="name_field" />

        <label for="number_field">Number:</label>
        <input type="number" name="tasktitle" id="number_field">

        <button onclick="addContact()">Add</button>

        <div class="alert alert-success" style="display: none" id="cont_suc_alert">
            Cotact added</div>
    </div>

    <!-- Phones tab -->
    <div>

        <button onclick="downloadContacts()">Update</button>
        <table class="table table-bordered">
            <thead>
                <tr>
                    <th>ID</th>
                    <th>Name</th>
                    <th>Phone number</th>
                </tr>
            </thead>

            <tbody id="contacts_table_body">


            </tbody>
        </table>

    </div>

    <script>

        window.onload = function () {
            downloadContacts();
        };

        /**
                     * Download contacts from the server
                     * 
                     * @returns {undefined}
                     */
        function downloadContacts() {
            tableBody = document.getElementById("contacts_table_body");
            console.log("TB: " + tableBody);
            req = new XMLHttpRequest();
            req.onreadystatechange = function () {
                console.log("orsc. s: " + req.readyState);
                // console.log("stat: "+r)
                if (req.readyState === 4 && req.status === 200) {
                    console.log("rs 4");
                    var ctArray = req.responseText;

                    console.log("Resp text: " + ctArray);

                    var contacts = JSON.parse(ctArray);

                    //Clear the table
                    tableBody.innerHTML = "";

                    contacts.forEach(function (val, idx, array) {
                        //id
                        nodeTr = document.createElement('tr');
                        nodeTd = document.createElement('td');
                        textNode = document.createTextNode(val.id);
                        nodeTd.appendChild(textNode);
                        nodeTr.appendChild(nodeTd);

                        //name
                        nodeTd = document.createElement('td');
                        textNode = document.createTextNode(val.name);
                        nodeTd.appendChild(textNode);
                        nodeTr.appendChild(nodeTd);

                        //number
                        nodeTd = document.createElement('td');
                        textNode = document.createTextNode(val.number);
                        nodeTd.appendChild(textNode);
                        nodeTr.appendChild(nodeTd);

                        tableBody.appendChild(nodeTr);
                        console.log("adic n√≥");
                    });

                }
            };
            req.open("get", "http://127.0.0.1:3000/contacts");
            req.send();
        }

        function addContact() {
            nameField = document.getElementById("name_field");
            numberField = document.getElementById("number_field");
            req = new XMLHttpRequest();
            req.onreadystatechange = function () {
                console.log("orsc. s: " + req.readyState);
                if (req.readyState === 4 && req.status === 200) {
                    console.log("rs 4");

                    nameField.value = "";
                    numberField.value = "";

                    document.getElementById("cont_suc_alert").style.
                        display = "block";
                    window.setTimeout(function () {
                        hideNofifyContAdded();
                    }, 3000);

                    downloadContacts();
                }
            };
            req.open("POST", "http://127.0.0.1:3000/new_contact", true);
            var newCont = {
                id: '', name: nameField.value,
                number: numberField.value
            };
            req.setRequestHeader("Content-Type", "application/json");
            req.send(JSON.stringify(newCont));

        }

        function hideNofifyContAdded() {
            console.log("hiding");
            document.getElementById("cont_suc_alert").style.
                display = "none";
        }
    </script>
</body>

</html>